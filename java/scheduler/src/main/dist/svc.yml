name: {{FRAMEWORK_NAME}}
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  hivemq:
    count: {{NODE_COUNT}}
    allow-decommission: true
    placement: '{{{NODE_PLACEMENT}}}'
    {{#ENABLE_VIRTUAL_NETWORK}}
      networks:
        {{VIRTUAL_NETWORK_NAME}}:
    labels: {{VIRTUAL_NETWORK_PLUGIN_LABELS}}
    {{/ENABLE_VIRTUAL_NETWORK}}
    uris:
      - {{HIVEMQ_JRE_URI}}
      - {{HIVEMQ_DCOS_URI}}
      - {{HIVEMQ_URI}}
      - {{BOOTSTRAP_URI}}
    tasks:
      node:
        goal: RUNNING
        cmd: |
          set -e
          set -o xtrace
          ls -la $MESOS_SANDBOX

          ./bootstrap -resolve=false

          export JAVA_HOME=$MESOS_SANDBOX/jdk-11.0.2+9-jre

          # TODO template the version
          cp -rp dcos_files/* $MESOS_SANDBOX/hivemq-4.0.2/
          # TODO template out these java_opts?

          JAVA_OPTS="-XX:+UnlockExperimentalVMOptions -XX:+UseNUMA" exec $MESOS_SANDBOX/hivemq-4.0.2/bin/run_dcos.sh
        cpus: {{NODE_CPUS}}
        configs:
          logback:
            template: logback.xml
            # TODO template the version
            dest: hivemq-4.0.2/conf/logback.xml
        memory: {{NODE_MEM}}
        volume:
          path: "test-container-path"
          type: {{NODE_DISK_TYPE}}
          size: {{NODE_DISK}}
        discovery:
          prefix: {{FRAMEWORK_NAME}}
        labels: "HAPROXY_GROUP:external"
        env:
          HIVEMQ_DNS_DISCOVERY_INTERVAL: 30
          HIVEMQ_CONTROL_CENTER_USER: admin
          HIVEMQ_CONTROL_CENTER_PASSWORD: a68fc32fc49fc4d04c63724a1f6d0c90442209c46dba6975774cde5e5149caf8
        health-check:
          cmd: "exec $MESOS_SANDBOX/hivemq-4.0.2/bin/healthcheck"
          interval: 60
          grace-period: 60
          max-consecutive-failures: 60
          delay: 10
          timeout: 30
        readiness-check:
          cmd: "exec $MESOS_SANDBOX/hivemq-4.0.2/bin/healthcheck"
          interval: 60
          delay: 30
          timeout: 30
        ports:
          mqtt:
            port: 0
            env-key: HIVEMQ_MQTT_PORT
            advertise: true
            vip:
              port: 1883
          cluster:
            port: 0
            env-key: HIVEMQ_CLUSTER_PORT
            advertise: true
          control-center:
            port: 0
            env-key: HIVEMQ_CONTROL_CENTER_PORT
            advertise: true
plans:
  deploy:
    strategy: serial
    phases:
      node:
        strategy: serial
        pod: hivemq
  update:
    strategy: serial
    phases:
      rolling-upgrade:
        strategy: serial
        pod: hivemq